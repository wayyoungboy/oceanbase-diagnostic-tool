name: build package

on:
  pull_request:
    branches:
      - master
      - 420-refactor
  push:
    branches:
      - master
      - 420-refactor

env:
  ACTIONS_ALLOW_USE_UNSECURE_NODE_VERSION: true
  PYTHON_VERSION: '3.11'
  CONTAINER_NAME: obdiag_ob
  ARTIFACT_RETENTION_DAYS: 3

jobs:
  cancel:
    runs-on: ubuntu-latest
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.12.1

  build-rpm:
    name: Build RPM Package
    needs: cancel
    runs-on: ubuntu-latest
    timeout-minutes: 60
    container:
      image: "registry.openanolis.cn/openanolis/anolisos:23.4"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies and build obdiag rpm
        run: |
          set -e
          yum install -y wget rpm-build gcc gcc-c++ make
          wget --quiet https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh --no-check-certificate
          sh Miniconda3-latest-Linux-x86_64.sh -p /opt/miniconda3 -b
          export PATH=/opt/miniconda3/bin:$PATH
          /opt/miniconda3/bin/conda init
          /opt/miniconda3/bin/conda create --name obdiag python=${{ env.PYTHON_VERSION }} -y
          source /opt/miniconda3/bin/activate obdiag
          /opt/miniconda3/envs/obdiag/bin/python3 -m pip install --upgrade pip setuptools wheel
          source activate obdiag
          pip3 install .[build]
          make pack

      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: obdiag-rpm-packages
          path: |
            /github/home/rpmbuild/RPMS/x86_64/oceanbase-diagnostic-tool-*.rpm
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  convert-to-deb:
    name: Convert RPM to DEB
    needs: build-rpm
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download RPM Artifact
        uses: actions/download-artifact@v4
        with:
          name: obdiag-rpm-packages
          path: .

      - name: Install Alien
        run: |
          sudo apt-get update
          sudo apt-get install -y alien

      - name: Convert RPM to DEB
        run: |
          sudo alien -k --scripts oceanbase-diagnostic-tool-*.rpm

      - name: Upload DEB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: obdiag-deb-package
          path: ./oceanbase-diagnostic-tool_*.deb
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build-macos-arm:
    name: Build macOS ARM64 Package
    needs: cancel
    runs-on: macos-14
    timeout-minutes: 90

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Get version and release info
        id: version
        run: |
          VERSION=$(grep -E "^OBDIAG_VERSION" Makefile | head -1 | cut -d'=' -f2 | tr -d ' ' || echo "4.0.0")
          RELEASE=$(date +%Y%m%d%H%M)
          ARCH=$(uname -m)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "release=${RELEASE}" >> $GITHUB_OUTPUT
          echo "arch=${ARCH}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}, release: ${RELEASE}, arch: ${ARCH}"

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip setuptools wheel
          pip3 install .[macos,build]
          pip3 uninstall -y pyminizip 2>/dev/null || true
          pip3 install pyzipper==0.3.6

      - name: Update version info
        run: |
          BUILD_TIME=$(date "+%Y-%m-%d %H:%M:%S")
          VERSION=${{ steps.version.outputs.version }}
          sed -i '' "s/<B_TIME>/${BUILD_TIME}/g" ./src/common/version.py
          sed -i '' "s/<VERSION>/${VERSION}/g" ./src/common/version.py

      - name: Build macOS binary with PyInstaller
        run: |
          cp src/main.py src/obdiag.py
          pyinstaller \
            --name obdiag \
            --onefile \
            --hidden-import=decimal \
            --hidden-import=pyzipper \
            --hidden-import=pymysql \
            --hidden-import=paramiko \
            --hidden-import=yaml \
            --hidden-import=jinja2 \
            --hidden-import=requests \
            --hidden-import=tabulate \
            --hidden-import=prettytable \
            --hidden-import=colorama \
            --paths="./src" \
            --clean \
            src/obdiag.py
          rm -f src/obdiag.py

      - name: Create distribution package
        run: |
          VERSION=${{ steps.version.outputs.version }}
          RELEASE=${{ steps.version.outputs.release }}
          ARCH=${{ steps.version.outputs.arch }}
          PKG_NAME="obdiag-${VERSION}-${RELEASE}-macos-${ARCH}"
          
          mkdir -p dist_pkg/${PKG_NAME}/{bin,plugins,conf,example,resources}
          
          # Copy binary
          cp dist/obdiag dist_pkg/${PKG_NAME}/bin/
          chmod +x dist_pkg/${PKG_NAME}/bin/obdiag
          
          # Copy plugins, conf, example, resources
          cp -r plugins/* dist_pkg/${PKG_NAME}/plugins/
          cp -r conf/* dist_pkg/${PKG_NAME}/conf/
          cp -r example/* dist_pkg/${PKG_NAME}/example/
          cp -r resources/* dist_pkg/${PKG_NAME}/resources/ 2>/dev/null || true
          
          # Copy install scripts
          cp macos/install.sh dist_pkg/${PKG_NAME}/
          cp macos/uninstall.sh dist_pkg/${PKG_NAME}/
          chmod +x dist_pkg/${PKG_NAME}/*.sh
          
          # Create README
          cat > dist_pkg/${PKG_NAME}/README.txt << EOF
          OceanBase Diagnostic Tool - macOS Package
          ==========================================
          Version: ${VERSION}
          Build:   ${RELEASE}
          Arch:    ${ARCH}
          
          Installation:
            ./install.sh
          
          Usage:
            obdiag --help
          
          More Info:
            https://github.com/oceanbase/obdiag
          EOF
          
          # Create archives
          cd dist_pkg
          tar -czf ${PKG_NAME}.tar.gz ${PKG_NAME}
          zip -r ${PKG_NAME}.zip ${PKG_NAME}
          
          # Show results
          ls -lh ${PKG_NAME}.*
          shasum -a 256 ${PKG_NAME}.*

      - name: Upload macOS ARM64 Package
        uses: actions/upload-artifact@v4
        with:
          name: obdiag-macos-arm64-package
          path: |
            dist_pkg/*.tar.gz
            dist_pkg/*.zip
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  test-with-observer:
    name: Test with Observer ${{ matrix.version }}
    needs: build-rpm
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - version: latest
            image: oceanbase/oceanbase-ce:latest
            config_file: config.yml
          - version: 4.2.1
            image: oceanbase/oceanbase-ce:4.2.1
            config_file: config.yml.421
          - version: 4.2.5
            image: oceanbase/oceanbase-ce:4.2.5.1-101000092024120918
            config_file: config.yml.421
          - version: 4.3.5
            image: oceanbase/oceanbase-ce:4.3.5-lts
            config_file: config.yml

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download RPM Artifact
        uses: actions/download-artifact@v4
        with:
          name: obdiag-rpm-packages
          path: .

      - name: Install obdiag
        run: |
          set -e
          docker run -id --name "${{ env.CONTAINER_NAME }}" \
            -e tag="${{ matrix.version }}" \
            ${{ matrix.image }}
          bash workflow_data/wait_observer_run.sh
          docker cp oceanbase-diagnostic-tool-*.rpm ${{ env.CONTAINER_NAME }}:/root/
          docker exec -i ${{ env.CONTAINER_NAME }} /bin/bash -c "rpm -ivh /root/oceanbase-diagnostic-tool-*.rpm"
          docker cp workflow_data/${{ matrix.config_file }} ${{ env.CONTAINER_NAME }}:/root/.obdiag/config.yml

      - name: Run obdiag test
        run: |
          set -e
          docker cp workflow_data/run_obdiag_test.sh ${{ env.CONTAINER_NAME }}:/root/run_obdiag_test.sh
          docker exec -i ${{ env.CONTAINER_NAME }} /bin/bash -c "obclient -h127.0.0.1 -u root -P2881 -e 'select version();'"
          docker exec -i ${{ env.CONTAINER_NAME }} /bin/bash -c "export tag=${{ matrix.version }} && sh /root/run_obdiag_test.sh"
          echo "obdiag install success"

      - name: Cleanup
        if: always()
        run: |
          docker rm -f ${{ env.CONTAINER_NAME }} || true